// This is your Prisma schema file
// Governance: PascalCase models â†’ snake_case DB tables/columns

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// TENANT REALM
// ============================================================

model Tenant {
  id        String   @id @default(uuid()) @db.Uuid
  slug      String   @unique @db.VarChar(100)
  name      String   @db.VarChar(255)
  type      TenantType @default(B2B)
  status    TenantStatus @default(ACTIVE)
  plan      TenantPlan @default(FREE)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  domains           TenantDomain[]
  branding          TenantBranding?
  memberships       Membership[]
  invites           Invite[]
  featureOverrides  TenantFeatureOverride[]
  aiBudget          AiBudget?
  aiUsageMeters     AiUsageMeter[]
  auditLogs         AuditLog[]
  impersonationSessions ImpersonationSession[]

  @@map("tenants")
}

model TenantDomain {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  domain    String   @unique @db.VarChar(255)
  verified  Boolean  @default(false)
  primary   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("tenant_domains")
}

model TenantBranding {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @unique @map("tenant_id") @db.Uuid
  logoUrl   String?  @map("logo_url") @db.VarChar(500)
  themeJson Json?    @map("theme_json") @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_branding")
}

model User {
  id                String    @id @default(uuid()) @db.Uuid
  email             String    @unique @db.VarChar(255)
  passwordHash      String    @map("password_hash") @db.VarChar(255)
  emailVerified     Boolean   @default(false) @map("email_verified")
  emailVerifiedAt   DateTime? @map("email_verified_at") @db.Timestamptz(6)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  memberships      Membership[]
  passwordResetTokens PasswordResetToken[]

  @@map("users")
}

model Membership {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  role      MembershipRole @default(MEMBER)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@index([userId])
  @@map("memberships")
}

model Invite {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  email     String   @db.VarChar(255)
  role      MembershipRole @default(MEMBER)
  tokenHash String   @map("token_hash") @db.VarChar(255)
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  acceptedAt DateTime? @map("accepted_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([email])
  @@index([tokenHash])
  @@map("invites")
}

model PasswordResetToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tokenHash String   @map("token_hash") @db.VarChar(255)
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  usedAt    DateTime? @map("used_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("password_reset_tokens")
}

// ============================================================
// ADMIN REALM
// ============================================================

model AdminUser {
  id           String    @id @default(uuid()) @db.Uuid
  email        String    @unique @db.VarChar(255)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  role         AdminRole @default(ANALYST)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  auditLogs             AuditLog[]
  impersonationSessions ImpersonationSession[]

  @@map("admin_users")
}

// ============================================================
// AUDIT & COMPLIANCE
// ============================================================

model AuditLog {
  id        String      @id @default(uuid()) @db.Uuid
  realm     AuditRealm
  tenantId  String?     @map("tenant_id") @db.Uuid
  actorId   String      @map("actor_id") @db.Uuid
  actorType ActorType   @map("actor_type")
  action    String      @db.VarChar(100)
  entity    String      @db.VarChar(100)
  entityId  String?     @map("entity_id") @db.Uuid
  beforeJson Json?      @map("before_json") @db.JsonB
  afterJson  Json?      @map("after_json") @db.JsonB
  metadataJson Json?    @map("metadata_json") @db.JsonB
  createdAt DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  tenant    Tenant?    @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  adminUser AdminUser? @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([actorId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================
// FEATURE FLAGS
// ============================================================

model FeatureFlag {
  key         String   @id @db.VarChar(100)
  enabled     Boolean  @default(false)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  tenantOverrides TenantFeatureOverride[]

  @@map("feature_flags")
}

model TenantFeatureOverride {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  key       String   @db.VarChar(100)
  enabled   Boolean
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  featureFlag FeatureFlag @relation(fields: [key], references: [key], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([tenantId])
  @@index([key])
  @@map("tenant_feature_overrides")
}

// ============================================================
// AI GOVERNANCE
// ============================================================

model AiBudget {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @unique @map("tenant_id") @db.Uuid
  monthlyLimit Int      @map("monthly_limit")
  hardStop     Boolean  @default(false) @map("hard_stop")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("ai_budgets")
}

model AiUsageMeter {
  id            String   @id @default(uuid()) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  month         String   @db.VarChar(7) // Format: YYYY-MM
  tokens        Int      @default(0)
  costEstimate  Decimal  @default(0) @map("cost_estimate") @db.Decimal(10, 4)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, month])
  @@index([tenantId])
  @@index([month])
  @@map("ai_usage_meters")
}

// ============================================================
// IMPERSONATION (SUPPORT)
// ============================================================

model ImpersonationSession {
  id        String   @id @default(uuid()) @db.Uuid
  adminId   String   @map("admin_id") @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  reason    String?  @db.Text
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  endedAt   DateTime? @map("ended_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  admin  AdminUser @relation(fields: [adminId], references: [id], onDelete: Cascade)
  tenant Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([tenantId])
  @@index([expiresAt])
  @@map("impersonation_sessions")
}

// ============================================================
// ENUMS
// ============================================================

enum TenantType {
  B2B
  B2C
  INTERNAL

  @@map("tenant_type")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CLOSED

  @@map("tenant_status")
}

enum TenantPlan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE

  @@map("tenant_plan")
}

enum MembershipRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER

  @@map("membership_role")
}

enum AdminRole {
  SUPER_ADMIN
  SUPPORT
  ANALYST

  @@map("admin_role")
}

enum AuditRealm {
  TENANT
  ADMIN

  @@map("audit_realm")
}

enum ActorType {
  USER
  ADMIN
  SYSTEM

  @@map("actor_type")
}
