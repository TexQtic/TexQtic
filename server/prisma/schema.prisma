generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("MIGRATION_DATABASE_URL")
}

model Tenant {
  id                       String                   @id @default(uuid()) @db.Uuid
  slug                     String                   @unique @db.VarChar(100)
  name                     String                   @db.VarChar(255)
  type                     TenantType               @default(B2B)
  status                   TenantStatus             @default(ACTIVE)
  plan                     TenantPlan               @default(FREE)
  createdAt                DateTime                 @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                DateTime                 @updatedAt @map("updated_at") @db.Timestamptz(6)
  aiBudget                 AiBudget?
  aiUsageMeters            AiUsageMeter[]
  auditLogs                AuditLog[]
  impersonationSessions    ImpersonationSession[]
  invites                  Invite[]
  memberships              Membership[]
  branding                 TenantBranding?
  domains                  TenantDomain[]
  featureOverrides         TenantFeatureOverride[]
  catalogItems             CatalogItem[]
  carts                    Cart[]
  marketplaceCartSummaries MarketplaceCartSummary[]

  @@map("tenants")
}

model TenantDomain {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  domain    String   @unique @db.VarChar(255)
  verified  Boolean  @default(false)
  primary   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("tenant_domains")
}

model TenantBranding {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @unique @map("tenant_id") @db.Uuid
  logoUrl   String?  @map("logo_url") @db.VarChar(500)
  themeJson Json?    @map("theme_json")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_branding")
}

model User {
  id                       String                   @id @default(uuid()) @db.Uuid
  email                    String                   @unique @db.VarChar(255)
  passwordHash             String                   @map("password_hash") @db.VarChar(255)
  emailVerified            Boolean                  @default(false) @map("email_verified")
  emailVerifiedAt          DateTime?                @map("email_verified_at") @db.Timestamptz(6)
  createdAt                DateTime                 @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                DateTime                 @updatedAt @map("updated_at") @db.Timestamptz(6)
  memberships              Membership[]
  passwordResetTokens      PasswordResetToken[]
  refreshTokens            RefreshToken[]
  carts                    Cart[]
  marketplaceCartSummaries MarketplaceCartSummary[]

  @@map("users")
}

model Membership {
  id        String         @id @default(uuid()) @db.Uuid
  userId    String         @map("user_id") @db.Uuid
  tenantId  String         @map("tenant_id") @db.Uuid
  role      MembershipRole @default(MEMBER)
  createdAt DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant    Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@index([userId])
  @@map("memberships")
}

model Invite {
  id         String         @id @default(uuid()) @db.Uuid
  tenantId   String         @map("tenant_id") @db.Uuid
  email      String         @db.VarChar(255)
  role       MembershipRole @default(MEMBER)
  tokenHash  String         @map("token_hash") @db.VarChar(255)
  expiresAt  DateTime       @map("expires_at") @db.Timestamptz(6)
  acceptedAt DateTime?      @map("accepted_at") @db.Timestamptz(6)
  createdAt  DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  tenant     Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([email])
  @@index([tokenHash])
  @@map("invites")
}

model PasswordResetToken {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  tokenHash String    @map("token_hash") @db.VarChar(255)
  expiresAt DateTime  @map("expires_at") @db.Timestamptz(6)
  usedAt    DateTime? @map("used_at") @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("password_reset_tokens")
}

model RefreshToken {
  id         String     @id @default(uuid()) @db.Uuid
  userId     String?    @map("user_id") @db.Uuid
  adminId    String?    @map("admin_id") @db.Uuid
  tokenHash  String     @unique @map("token_hash") @db.VarChar(255)
  familyId   String     @map("family_id") @db.Uuid
  expiresAt  DateTime   @map("expires_at") @db.Timestamptz(6)
  revokedAt  DateTime?  @map("revoked_at") @db.Timestamptz(6)
  rotatedAt  DateTime?  @map("rotated_at") @db.Timestamptz(6)
  lastUsedAt DateTime?  @map("last_used_at") @db.Timestamptz(6)
  ip         String?    @db.VarChar(45)
  userAgent  String?    @map("user_agent") @db.VarChar(500)
  createdAt  DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  user       User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  admin      AdminUser? @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([adminId])
  @@index([familyId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model RateLimitAttempt {
  id        String   @id @default(uuid()) @db.Uuid
  key       String   @db.VarChar(255)
  endpoint  String   @db.VarChar(100)
  realm     String   @db.VarChar(20)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)

  @@index([key])
  @@index([expiresAt])
  @@index([key, expiresAt])
  @@map("rate_limit_attempts")
}

model AdminUser {
  id                    String                 @id @default(uuid()) @db.Uuid
  email                 String                 @unique @db.VarChar(255)
  passwordHash          String                 @map("password_hash") @db.VarChar(255)
  role                  AdminRole              @default(ANALYST)
  createdAt             DateTime               @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime               @updatedAt @map("updated_at") @db.Timestamptz(6)
  impersonationSessions ImpersonationSession[]
  refreshTokens         RefreshToken[]

  @@map("admin_users")
}

model AuditLog {
  id           String     @id @default(uuid()) @db.Uuid
  realm        AuditRealm
  tenantId     String?    @map("tenant_id") @db.Uuid
  actorId      String?    @map("actor_id") @db.Uuid
  actorType    ActorType  @map("actor_type")
  action       String     @db.VarChar(100)
  entity       String     @db.VarChar(100)
  entityId     String?    @map("entity_id") @db.Uuid
  beforeJson   Json?      @map("before_json")
  afterJson    Json?      @map("after_json")
  metadataJson Json?      @map("metadata_json")
  createdAt    DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  tenant       Tenant?    @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([actorId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

model EventLog {
  id           String   @id @db.Uuid
  version      String   @db.VarChar(10)
  name         String   @db.VarChar(100)
  occurredAt   DateTime @map("occurred_at") @db.Timestamptz(6)
  tenantId     String?  @map("tenant_id") @db.Uuid
  realm        String   @db.VarChar(20)
  actorType    String   @map("actor_type") @db.VarChar(20)
  actorId      String?  @map("actor_id") @db.Uuid
  entityType   String   @map("entity_type") @db.VarChar(100)
  entityId     String   @map("entity_id") @db.Uuid
  payloadJson  Json?    @map("payload_json")
  metadataJson Json?    @map("metadata_json")
  auditLogId   String   @unique @map("audit_log_id") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([tenantId, occurredAt])
  @@index([name, occurredAt])
  @@index([entityType, entityId])
  @@map("event_logs")
}

model FeatureFlag {
  key             String                  @id @db.VarChar(100)
  enabled         Boolean                 @default(false)
  description     String?
  createdAt       DateTime                @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime                @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenantOverrides TenantFeatureOverride[]

  @@map("feature_flags")
}

model TenantFeatureOverride {
  id          String      @id @default(uuid()) @db.Uuid
  tenantId    String      @map("tenant_id") @db.Uuid
  key         String      @db.VarChar(100)
  enabled     Boolean
  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)
  featureFlag FeatureFlag @relation(fields: [key], references: [key], onDelete: Cascade)
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([tenantId])
  @@index([key])
  @@map("tenant_feature_overrides")
}

model AiBudget {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @unique @map("tenant_id") @db.Uuid
  monthlyLimit Int      @map("monthly_limit")
  hardStop     Boolean  @default(false) @map("hard_stop")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("ai_budgets")
}

model AiUsageMeter {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  month        String   @db.VarChar(7)
  tokens       Int      @default(0)
  costEstimate Decimal  @default(0) @map("cost_estimate") @db.Decimal(10, 4)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, month])
  @@index([tenantId])
  @@index([month])
  @@map("ai_usage_meters")
}

model ImpersonationSession {
  id        String    @id @default(uuid()) @db.Uuid
  adminId   String    @map("admin_id") @db.Uuid
  tenantId  String    @map("tenant_id") @db.Uuid
  reason    String?
  expiresAt DateTime  @map("expires_at") @db.Timestamptz(6)
  endedAt   DateTime? @map("ended_at") @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  admin     AdminUser @relation(fields: [adminId], references: [id], onDelete: Cascade)
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([tenantId])
  @@index([expiresAt])
  @@map("impersonation_sessions")
}

model CatalogItem {
  id          String     @id @default(uuid()) @db.Uuid
  tenantId    String     @map("tenant_id") @db.Uuid
  name        String     @db.VarChar(255)
  sku         String?    @db.VarChar(100)
  description String?
  price       Decimal?   @db.Decimal(10, 2)
  active      Boolean    @default(true)
  createdAt   DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime   @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant      Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cartItems   CartItem[]

  @@index([tenantId, active])
  @@index([tenantId, updatedAt])
  @@map("catalog_items")
}

model Cart {
  id        String                  @id @default(uuid()) @db.Uuid
  tenantId  String                  @map("tenant_id") @db.Uuid
  userId    String                  @map("user_id") @db.Uuid
  status    CartStatus              @default(ACTIVE)
  createdAt DateTime                @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime                @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant    Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
  summary   MarketplaceCartSummary?

  @@index([tenantId, userId, status])
  @@index([tenantId, updatedAt])
  @@map("carts")
}

model CartItem {
  id            String      @id @default(uuid()) @db.Uuid
  cartId        String      @map("cart_id") @db.Uuid
  catalogItemId String      @map("catalog_item_id") @db.Uuid
  quantity      Int
  createdAt     DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)
  cart          Cart        @relation(fields: [cartId], references: [id], onDelete: Cascade)
  catalogItem   CatalogItem @relation(fields: [catalogItemId], references: [id], onDelete: Cascade)

  @@unique([cartId, catalogItemId])
  @@index([cartId])
  @@index([catalogItemId])
  @@map("cart_items")
}

enum TenantType {
  B2B
  B2C
  INTERNAL

  @@map("tenant_type")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CLOSED

  @@map("tenant_status")
}

enum TenantPlan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE

  @@map("tenant_plan")
}

enum MembershipRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER

  @@map("membership_role")
}

enum AdminRole {
  SUPER_ADMIN
  SUPPORT
  ANALYST

  @@map("admin_role")
}

enum AuditRealm {
  TENANT
  ADMIN

  @@map("audit_realm")
}

enum ActorType {
  USER
  ADMIN
  SYSTEM

  @@map("actor_type")
}

enum CartStatus {
  ACTIVE
  CHECKED_OUT
  ABANDONED

  @@map("cart_status")
}

// ============================================================================
// EVENT PROJECTIONS (Read Models)
// ============================================================================
// Domain: marketplace
// Plane: tenant-plane
// Lifecycle: event-driven projection (append/update from events)
// Purpose: Read-optimized view of cart state for admin & analytics queries
// RLS: Yes (tenant-scoped, multi-tenant isolation required)
// Indexes: tenant queries, cart lookups, temporal ordering
// Idempotency: last_event_id + version for replay safety

model MarketplaceCartSummary {
  id            String   @id @default(uuid()) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  cartId        String   @unique @map("cart_id") @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  itemCount     Int      @default(0) @map("item_count")
  totalQuantity Int      @default(0) @map("total_quantity")
  lastEventId   String?  @map("last_event_id") @db.Uuid
  version       Int      @default(1)
  lastUpdatedAt DateTime @map("last_updated_at") @db.Timestamptz(6)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cart          Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, lastUpdatedAt])
  @@index([tenantId, userId])
  @@index([cartId])
  @@map("marketplace_cart_summaries")
}
